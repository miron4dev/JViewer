<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:tk="http://jviewer.tk/components"
      xmlns:p="http://primefaces.org/ui"
      xmlns:pe="http://primefaces.org/ui/extensions"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

<h:head>
    <title>Новости</title>
    <link rel="icon" type="image/x-icon" href="resources/images/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="resources/css/news.css"/>

    <script type="text/javascript">
        function aliveLinks() {
            console.log('inside aliveLinks()');
            $('iframe').contents().click(function(e) {
                if(typeof e.target.href != 'undefined') {
                    window.open(e.target.href, 'new' + e.screenX);
                }
            });
        }
    </script>
</h:head>
<h:body>
    <tk:template id="template" currentPage="NEWS">
        <h:form>
            <p:remoteCommand name="refreshCreateNews" update=":template:writeNews"/>
        </h:form>

        <p:dataList id="news" value="#{newsController.news}" var="news" varStatus="status" paginator="true" rows="5" paginatorPosition="bottom">
            <div class="page-header">
                <h2><h:outputText value="#{news.topic}"/>
                    <h:panelGroup layout="block" rendered="#{userModel.authenticated}">
                        <p:commandLink onclick="PF('editDialog').show()" title="Отредактировать" update=":template:editDialogContent">
                            <h:graphicImage library="images" name="button_edit.png" />
                            <f:setPropertyActionListener target="#{newsModel.id}" value="#{news.id}"/>
                            <f:setPropertyActionListener target="#{newsModel.topic}" value="#{news.topic}"/>
                            <f:setPropertyActionListener target="#{newsModel.text}" value="#{news.text}"/>
                            <f:setPropertyActionListener target="#{newsModel.author}" value="#{news.author}"/>
                        </p:commandLink>
                        <p:commandLink onclick="PF('deleteDialog_#{news.id}').show()" title="Удалить">
                            <h:graphicImage library="images" name="button_delete.png" />
                        </p:commandLink>

                        <p:confirmDialog widgetVar="deleteDialog_#{news.id}" showEffect="fade" header="Подтверждение"
                                         message="Вы действительно хотите удалить данную новость?">
                            <h:form style="text-align: center">
                                <p:commandButton value="Да" actionListener="#{newsController.deleteNews(news.id)}"
                                                 styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                                <p:commandButton value="Нет" onclick="PF('deleteDialog_#{news.id}').hide();" type="button"
                                                 styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                            </h:form>
                        </p:confirmDialog>
                    </h:panelGroup>
                </h2>
                <small style="font-size: 75%"><h:outputText value="#{news.date} by #{news.author}"/></small>
                <br/>
                <pe:ckEditor value="#{news.text}" customConfig="resources/plugins/ckeditor/config.js">
                    <pe:javascript event="initialize" execute="if (#{status.isLast()}) aliveLinks();"/>
                </pe:ckEditor>
            </div>
        </p:dataList>
        <h:panelGroup layout="block" rendered="#{userModel.authenticated}">
            <p:dialog widgetVar="editDialog" modal="true" resizable="false" showEffect="fade" header="Редактирование новости"
                      onShow="refreshCreateNews();" onHide="refreshCreateNews();">
                <h:form id="editDialogContent">
                    <h:inputHidden value="#{newsModel.id}"/>
                    <p:inputText widgetVar="newsTopic" value="#{newsModel.topic}" style="width:100%" placeholder="Тема" required="true"/><br/><br/>
                    <pe:ckEditor widgetVar="newsText" value="#{newsModel.text}" required="true"/><br/>
                    <p:commandButton value="Отредактировать" action="#{newsController.editNews}"/>
                </h:form>
            </p:dialog>
        </h:panelGroup>
        <h:panelGroup layout="block" rendered="#{userModel.authenticated}">
            <br/>
            <h:form id="writeNews">
                <p:inputText value="#{newsModel.topic}" styleClass="form-control" placeholder="Тема" required="true"/>
                <br/>
                    <pe:ckEditor value="#{newsModel.text}" required="true"/>
                <br/>
                <p:commandButton styleClass="btn btn-primary btn-lg btn-block" value="Опубликовать"
                                 actionListener="#{newsController.addNews}" />
            </h:form>
            <br/>
        </h:panelGroup>
    </tk:template>
</h:body>
</html>
